<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Псевдо-3D игра — Raycaster с джойстиком и кнопками поворота</title>
  <style>
    html,body{height:100%;margin:0;background:#111;color:#ddd;font-family:Segoe UI,Roboto,Arial}
    .wrap{display:flex;flex-direction:column;height:100%}
    header{padding:8px 12px;background:#0e0e0e;border-bottom:1px solid #222}
    header h1{margin:0;font-size:16px;font-weight:600}
    #game{flex:1;display:flex;align-items:stretch}
    canvas{background:#555;display:block;margin:auto;max-width:100%;height:auto}
    .hud{width:280px;min-width:220px;padding:12px;background:#0f0f0f;border-left:1px solid #222}
    .hint{font-size:13px;line-height:1.5;color:#bbb}
    .small{font-size:12px;color:#999}
    footer{padding:8px 12px;background:#0e0e0e;border-top:1px solid #222;font-size:13px}
    #joystickControls{position:fixed;bottom:20px;left:20px;display:none;z-index:20;}
    #rotationButtons{position:fixed;bottom:20px;right:20px;display:none;flex-direction:column;gap:6px;z-index:20;}
    #rotationButtons button{width:60px;height:40px;font-size:16px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Псевдо-3D (raycaster) — джойстик и кнопки поворота</h1>
    </header>
    <div id="game">
      <canvas id="c" width="960" height="540"></canvas>
      <div class="hud">
        <div class="hint">Информация:</div>
        <div class="small" id="info">Загрузка...</div>
      </div>
    </div>
    <footer>Минимальный raycaster с джойстиком и кнопками для поворота камеры.</footer>
  </div>

<button id="modeBtn" style="position:fixed;top:10px;right:10px;z-index:10;">Mobile управление: выкл</button>

<div id="joystickControls">
  <div id="joystick" style="width:140px;height:140px;border-radius:50%;background:rgba(0,0,0,0.25);position:relative;touch-action:none;">
    <div id="stick" style="width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.85);position:absolute;left:40px;top:40px;transform:translate(0,0);transition:transform 0.05s linear;"></div>
  </div>
</div>

<div id="rotationButtons">
  <button id="turnLeft">⟲</button>
  <button id="turnRight">⟳</button>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;

// карта и игрок
const TILE=64;
const MAP=[
  [1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,1,1,1,0,0,0,0,1],
  [1,0,0,0,0,0,1,0,0,0,0,1],
  [1,0,0,0,0,0,1,0,1,0,0,1],
  [1,0,1,1,0,0,0,0,1,0,0,1],
  [1,0,0,1,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,1,1,1,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1]
];
const MAP_W = MAP[0].length, MAP_H = MAP.length;
let player={x:TILE*2.5,y:TILE*2.5,dir:0,fov:Math.PI/3,speed:140};
const keys={};
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
window.addEventListener('blur',()=>{for(let k in keys)keys[k]=false;});
function resetPlayer(){player.x=TILE*2.5;player.y=TILE*2.5;player.dir=0;}
function isWall(x,y){const tx=Math.floor(x/TILE),ty=Math.floor(y/TILE);return tx<0||tx>=MAP_W||ty<0||ty>=MAP_H||MAP[ty][tx]!==0;}

// отрисовка
function castRays(){
  const numRays=W,halfH=H/2,stripWidth=1,angleStep=player.fov/numRays;
  let angle=player.dir-player.fov/2;
  ctx.fillStyle='#87ceeb';ctx.fillRect(0,0,W,halfH);
  ctx.fillStyle='#222';ctx.fillRect(0,halfH,W,halfH);
  for(let i=0;i<numRays;i++,angle+=angleStep){
    let rx=Math.cos(angle),ry=Math.sin(angle),distance=0,hit=false,hx=0,hy=0;
    while(!hit&&distance<1000){distance+=1;
      const testX=Math.floor((player.x+rx*distance)/TILE),testY=Math.floor((player.y+ry*distance)/TILE);
      if(testX<0||testX>=MAP_W||testY<0||testY>=MAP_H){hit=true;break;}
      if(MAP[testY][testX]>0){hit=true;hx=testX;hy=testY;}
    }
    const correctedDist=distance*Math.cos(angle-player.dir),wallHeight=(TILE*H)/(correctedDist+0.0001);
    let shade=Math.max(0.2,1-correctedDist/800);
    const baseColor=((hx+hy)&1)?[200,80,60]:[180,180,180];
    ctx.fillStyle=`rgb(${Math.floor(baseColor[0]*shade)},${Math.floor(baseColor[1]*shade)},${Math.floor(baseColor[2]*shade)})`;
    ctx.fillRect(i*stripWidth,halfH-wallHeight/2,stripWidth,wallHeight);
  }
}

function update(dt){
  const moveStep=player.speed*dt,rotSpeed=2.5;
  let moveX=0,moveY=0;
  if(keys['w']){moveX+=Math.cos(player.dir)*moveStep;moveY+=Math.sin(player.dir)*moveStep;}
  if(keys['s']){moveX-=Math.cos(player.dir)*moveStep;moveY-=Math.sin(player.dir)*moveStep;}
  if(keys['a']){moveX+=Math.cos(player.dir-Math.PI/2)*moveStep;moveY+=Math.sin(player.dir-Math.PI/2)*moveStep;}
  if(keys['d']){moveX+=Math.cos(player.dir+Math.PI/2)*moveStep;moveY+=Math.sin(player.dir+Math.PI/2)*moveStep;}
  const nx=player.x+moveX,ny=player.y+moveY;
  if(!isWall(nx,player.y))player.x=nx;else player.x+=(Math.sign(moveX)||0)*4;
  if(!isWall(player.x,ny))player.y=ny;else player.y+=(Math.sign(moveY)||0)*4;
  // вращение через клавиши и кнопки
  if(keys['q'])player.dir-=rotSpeed*dt;
  if(keys['e'])player.dir+=rotSpeed*dt;
  info.innerText=`x:${player.x.toFixed(1)} y:${player.y.toFixed(1)} dir:${(player.dir%(Math.PI*2)).toFixed(2)}`;
}

let last=performance.now();
function step(now){const dt=(now-last)/1000;last=now;update(dt);castRays();requestAnimationFrame(step);}
resetPlayer();requestAnimationFrame(step);

// мобильный режим
let mobileMode=false;
const mCtrl=document.getElementById('joystickControls');
const rotBtns=document.getElementById('rotationButtons');
const modeBtn=document.getElementById('modeBtn');
modeBtn.onclick=()=>{
  mobileMode=!mobileMode;
  mCtrl.style.display=mobileMode?'block':'none';
  rotBtns.style.display=mobileMode?'flex':'none';
  modeBtn.innerText='Mobile управление: '+(mobileMode?'вкл':'выкл');
};

// джойстик
const joyArea=document.getElementById('joystick');
const stick=document.getElementById('stick');
let joyX=0,joyY=0,activePointerId=null,maxRadius=40,deadzone=0.2;
function setStickPosition(px,py){stick.style.transform=`translate(${px}px,${py}px)`;}
function updateJoyFromPoint(clientX,clientY){
  const rect=joyArea.getBoundingClientRect();
  let dx=clientX-(rect.left+rect.width/2),dy=clientY-(rect.top+rect.height/2);
  const dist=Math.hypot(dx,dy);
  if(dist>maxRadius){dx=dx/dist*maxRadius;dy=dy/dist*maxRadius;}
  setStickPosition(dx,dy);
  joyX=dx/maxRadius;joyY=dy/maxRadius;
  if(Math.abs(joyX)<deadzone)joyX=0;if(Math.abs(joyY)<deadzone)joyY=0;
}
function resetStick(){joyX=0;joyY=0;setStickPosition(0,0);activePointerId=null;}
joyArea.addEventListener('pointerdown',e=>{joyArea.setPointerCapture(e.pointerId);activePointerId=e.pointerId;updateJoyFromPoint(e.clientX,e.clientY);});
joyArea.addEventListener('pointermove',e=>{if(activePointerId!==e.pointerId)return;updateJoyFromPoint(e.clientX,e.clientY);});
joyArea.addEventListener('pointerup',e=>{if(activePointerId!==e.pointerId)return;joyArea.releasePointerCapture(e.pointerId);resetStick();});
joyArea.addEventListener('pointercancel',()=>{resetStick();});
setInterval(()=>{keys['w']=(joyY<-0.01);keys['s']=(joyY>0.01);keys['a']=(joyX<-0.01);keys['d']=(joyX>0.01);},16);

// кнопки поворота
document.getElementById('turnLeft').addEventListener('pointerdown',()=>keys['q']=true);
document.getElementById('turnLeft').addEventListener('pointerup',()=>keys['q']=false);
document.getElementById('turnRight').addEventListener('pointerdown',()=>keys['e']=true);
document.getElementById('turnRight').addEventListener('pointerup',()=>keys['e']=false);
</script>
</body>
</html>
